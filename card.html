<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cards Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body {
        background-color: #f8f9fa;
      }
      .btn-light {
        background-color: #ffffff;
        color: #007bff;
      }
      .nav-link.active {
        background-color: #007bff;
        color: white;
      }
      table th,
      table td {
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <h1 class="text-uppercase text-center text-primary">Cards</h1>

      <div class="d-flex gap-1">
        <a class="nav-link btn btn-primary text-white p-2" href="book.html"
          >Books</a
        >
        <a class="nav-link btn btn-primary text-white p-2" href="visitor.html"
          >Visitors</a
        >
        <a class="nav-link btn btn-primary text-white p-2" href="card.html"
          >Cards</a
        >
      </div>

      <!-- Add Card Button -->
      <div class="row py-3">
        <div
          class="col-md-12 bg-primary text-white p-3 rounded d-flex justify-content-between align-items-center"
        >
          <h5 class="m-0">All Cards</h5>
          <button
            class="btn btn-light btn-sm"
            id="addCardButton"
            data-bs-toggle="modal"
            data-bs-target="#addCardModal"
          >
            Add New Card
          </button>
        </div>
      </div>

      <!-- Card Search and Sort -->
      <div class="card p-3 shadow-sm">
        <div class="d-flex mb-3">
          <input
            type="text"
            id="searchCard"
            class="form-control"
            placeholder="Search by ID, Visitor or Book..."
          />
          <button class="btn btn-secondary" id="sortCard">Sort</button>
        </div>
        <table class="table table-hover" id="cardTable">
          <thead class="table-secondary">
            <tr>
              <th>#</th>
              <th>ID</th>
              <th>Visitor</th>
              <th>Book</th>
              <th>Borrow Date</th>
              <th>Return Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- Card rows will go here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal for Add/Edit Card -->
    <div
      class="modal fade"
      id="addCardModal"
      tabindex="-1"
      aria-labelledby="addCardModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addCardModalLabel">Add New Card</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="cardForm">
              <div class="mb-3">
                <label for="visitorID" class="form-label">Visitor</label>
                <select class="form-control" id="visitorID" required>
                  <option value="">Select Visitor</option>
                  <!-- Options will be populated dynamically -->
                </select>
              </div>
              <div class="mb-3">
                <label for="bookID" class="form-label">Book</label>
                <select class="form-control" id="bookID" required>
                  <option value="">Select Book</option>
                  <!-- Options will be populated dynamically -->
                </select>
              </div>
              <div class="mb-3 d-none">
                <label for="borrowDate" class="form-label">Borrow Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="borrowDate"
                  value=""
                  disabled
                />
              </div>
              <button type="submit" class="btn btn-primary">Save Card</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        const cards = JSON.parse(localStorage.getItem("cards")) || [];
        const visitors = JSON.parse(localStorage.getItem("visitors")) || [];
        const books = JSON.parse(localStorage.getItem("books")) || [];
        let currentIndex = null; // Track index for editing
        const cardTable = $("#cardTable tbody");

        // Populate visitor and book dropdowns dynamically
        visitors.forEach((visitor) => {
          $("#visitorID").append(new Option(visitor.name, visitor.id));
        });

        books.forEach((book) => {
          $("#bookID").append(new Option(book.name, book.id));
        });

        function loadCards() {
          cardTable.empty();
          cards.forEach((card, index) => {
            cardTable.append(`
              <tr>
                <td>${index + 1}</td>
                <td>${card.id}</td>
                <td>${card.visitorID}</td>
                <td>${card.bookID}</td>
                <td>${card.borrowDate}</td>
                <td>${
                  card.returnDate ||
                  `<button class="btn btn-success btn-sm returnBtn" data-index="${index}">Return</button>`
                }</td>
              </tr>
            `);
          });
        }

        loadCards();

        // Set borrow date to current date
        $("#borrowDate").val(new Date().toISOString().split("T")[0]);

        $("#cardForm").submit(function (e) {
          e.preventDefault();
          const visitorID = $("#visitorID").val();
          const bookID = $("#bookID").val();
          const borrowDate = $("#borrowDate").val();

          if (visitorID && bookID && borrowDate) {
            const newCard = {
              id: `${cards.length + 1}`, // Auto-generate Card ID
              visitorID: visitorID,
              bookID: bookID,
              borrowDate: borrowDate,
              returnDate: null,
            };

            if (currentIndex === null) {
              // Add new card
              cards.push(newCard);
            } else {
              // Edit existing card
              cards[currentIndex] = newCard;
              currentIndex = null;
            }

            localStorage.setItem("cards", JSON.stringify(cards));
            loadCards();
            $("#addCardModal").modal("hide");
            $("#cardForm")[0].reset();
          }
        });

        $("#searchCard").on("input", function () {
          const searchTerm = $(this).val().toLowerCase();
          $("#cardTable tbody tr").each(function () {
            const cardID = $(this).find("td:nth-child(2)").text().toLowerCase();
            const visitorID = $(this)
              .find("td:nth-child(3)")
              .text()
              .toLowerCase();
            const bookID = $(this).find("td:nth-child(4)").text().toLowerCase();
            $(this).toggle(
              cardID.includes(searchTerm) ||
                visitorID.includes(searchTerm) ||
                bookID.includes(searchTerm)
            );
          });
        });

        $("#sortCard").click(function () {
          cards.sort((a, b) => a.id.localeCompare(b.id));
          localStorage.setItem("cards", JSON.stringify(cards));
          loadCards();
        });

        $(document).on("click", ".editCard", function () {
          currentIndex = $(this).data("index");
          const card = cards[currentIndex];
          $("#visitorID").val(card.visitorID);
          $("#bookID").val(card.bookID);
          $("#borrowDate").val(card.borrowDate);
        });

        $(document).on("click", ".deleteCard", function () {
          const index = $(this).data("index");
          cards.splice(index, 1);
          localStorage.setItem("cards", JSON.stringify(cards));
          loadCards();
        });

        // Add return date when button is clicked
        $(document).on("click", ".returnBtn", function () {
          const index = $(this).data("index");
          const card = cards[index];
          card.returnDate = new Date().toISOString().split("T")[0]; // Set current date as return date
          localStorage.setItem("cards", JSON.stringify(cards));
          loadCards(); // Re-render the table
        });
      });
    </script>
  </body>
</html>
